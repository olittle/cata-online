#-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.-.
#
# File Name : view_noclick.py
#
# Purpose :
#
# Creation Date : 20-06-2013
#
# Last Modified : Mon 24 Jun 2013 10:49:03 AM PDT
#
# Created By : Huan Gui (hgui@linkedin.com) 
#
#_._._._._._._._._._._._._._._._._._._._._.
#import numpy as np 
#import random 

def Assign_Click(time, time_array):
    if time in time_array:
        return time 
    if time < time_array[0]: 
        return -1
    if time > time_array[-1]:
        return time_array[-1]
    
    lo = 0 
    hi = int(len(time_array) - 1)
    while lo < hi:
        mid = int((lo + hi) / 2)
        print "lo", lo, "hi", hi, "mid", mid 
        midval = time_array[mid] 
        if midval < time and time_array[mid+1] > time:
            attribute_time = midval
            break 
        elif midval < time:
            lo = mid
        elif midval > time:
            hi = mid
    return time_array[lo] 


@outputSchema("negs:bag{neg:tuple(jobId:int)}") 
def NonView(Impressions, Clicks):
    Impression_dict = {} 
    Click_dict = {} 
    Impression_time = {} 
    for impr in Impressions:
        time = impr[1]
        jId = impr[2]
        if jId not in Impression_dict:
            Impression_dict[jId] = [] 
        Impression_dict[jId].append(time)

        if time not in Impression_time:
            Impression_time[time] = [] 
        Impression_time[time].append(jId) 

    for clk in Clicks:
        time = clk[1]
        jId = clk[2]
        if jId not in Click_dict:
            Click_dict[jId] = time

    print "Impression_dict", Impression_dict 
    print "Impression_time", Impression_time
    print "Click_dict", Click_dict

    results = []  

    Click_dict_keys = Click_dict.keys()
    Click_dict_len = len(Click_dict_keys) 
    
    for i in range(Click_dict_len):
        jId = Click_dict_keys[i]
        print "jId", jId

        if jId not in Impression_dict:
            continue

        Impression_dict[jId] = sorted(Impression_dict[jId])
        attribute_time = Assign_Click(Click_dict[jId], Impression_dict[jId]) 
        print "attribute_time", attribute_time

        if attribute_time == -1:
            continue 
        
        for j in range(len(Impression_time[attribute_time])):
            impr = Impression_time[attribute_time][j]
            if impr != jId and (impr,) not in results:
                results.append((impr, )) 
    return results


if __name__ == "__main__":
    Impression = [] 
    Click = []
    job = np.arange(10)
    
    mem, impr, view = (50246,[(50246,1370468969359,5866176,5866176),(50246,1370494920157,5840228,5840228),(50246,1370474163380,4191489,4191489),(50246,1370483657288,5823705,5823705),(50246,1370468349955,5672279,5672279),(50246,1370468969359,5488449,5488449),(50246,1370452642298,4465612,4465612),(50246,1370469683262,5910499,5910499),(50246,1370450728943,5910499,5910499),(50246,1370491199962,5839629,5839629),(50246,1370453037669,5823705,5823705),(50246,1370459092643,5759963,5759963),(50246,1370493788641,4889479,4889479),(50246,1370473979035,5697728,5697728),(50246,1370446443873,5262530,5262530),(50246,1370465590341,5866984,5866984),(50246,1370460047869,5823705,5823705),(50246,1370462670541,5909759,5909759),(50246,1370446443873,5928717,5928717),(50246,1370446762052,5807217,5807217),(50246,1370463010383,5672279,5672279),(50246,1370475679688,5748104,5748104),(50246,1370450742857,5823705,5823705),(50246,1370487573922,5673492,5673492),(50246,1370475679688,5823705,5823705),(50246,1370450663269,5823315,5823315),(50246,1370473660760,5928717,5928717),(50246,1370483657288,5879831,5879831),(50246,1370481879125,5167099,5167099),(50246,1370463414019,5839629,5839629),(50246,1370463010383,5862457,5862457),(50246,1370477766694,5417000,5417000),(50246,1370487731589,5878716,5878716),(50246,1370487573922,5878716,5878716),(50246,1370480405929,5417000,5417000),(50246,1370451662405,5834282,5834282),(50246,1370481137285,5834282,5834282),(50246,1370451662405,5417000,5417000),(50246,1370477689325,5748060,5748060),(50246,1370453037669,5722118,5722118),(50246,1370480405929,5452270,5452270),(50246,1370473660760,5941865,5941865),(50246,1370477766694,5687411,5687411),(50246,1370450742858,5748060,5748060),(50246,1370453037669,5807217,5807217),(50246,1370463491712,5958234,5958234),(50246,1370460047869,5092408,5092408),(50246,1370477510761,5748104,5748104),(50246,1370452561634,5750970,5750970),(50246,1370451662405,5622767,5622767),(50246,1370465590341,5909759,5909759),(50246,1370487664760,5928717,5928717),(50246,1370468312039,4465612,4465612),(50246,1370481137285,5878716,5878716),(50246,1370473660760,5262530,5262530),(50246,1370446443874,5863427,5863427),(50246,1370475037378,5879831,5879831),(50246,1370493788641,5748060,5748060),(50246,1370469683262,5862457,5862457),(50246,1370475037378,5823315,5823315),(50246,1370474163379,5928717,5928717),(50246,1370468349955,5927737,5927737),(50246,1370471787652,5942347,5942347),(50246,1370477689325,5735395,5735395),(50246,1370452561634,5866141,5866141),(50246,1370471787653,5750970,5750970),(50246,1370481286454,5735395,5735395),(50246,1370473979035,5138411,5138411),(50246,1370458119424,5879831,5879831),(50246,1370467789442,5262530,5262530),(50246,1370487664760,5909759,5909759),(50246,1370459092643,5865782,5865782),(50246,1370491199962,5925516,5925516),(50246,1370463414019,5687411,5687411),(50246,1370477510761,4465612,4465612),(50246,1370494920157,5262530,5262530),(50246,1370481326020,5928717,5928717),(50246,1370481879125,5911258,5911258),(50246,1370481461465,5909759,5909759),(50246,1370452642298,5092408,5092408),(50246,1370450728943,5641238,5641238),(50246,1370450663269,5641238,5641238),(50246,1370450699674,5852252,5852252),(50246,1370462670541,5138411,5138411),(50246,1370481326020,5942347,5942347),(50246,1370480441319,5359887,5359887),(50246,1370494920157,5823315,5823315),(50246,1370487664760,5748104,5748104),(50246,1370481879125,5780337,5780337),(50246,1370450728943,5866984,5866984),(50246,1370481286454,5859940,5859940),(50246,1370481286454,5852252,5852252),(50246,1370474132205,5942347,5942347),(50246,1370480441319,5748060,5748060),(50246,1370452561634,5624324,5624324),(50246,1370473979035,5859940,5859940),(50246,1370483657288,5780337,5780337),(50246,1370463414019,5859940,5859940),(50246,1370463491712,5092408,5092408),(50246,1370463554356,5672279,5672279),(50246,1370469974461,5941858,5941858),(50246,1370463345234,5823705,5823705),(50246,1370465590341,5092408,5092408),(50246,1370475037378,5836650,5836650),(50246,1370452642298,5866176,5866176),(50246,1370463554356,5823705,5823705),(50246,1370477766694,5942347,5942347),(50246,1370474132205,5879831,5879831),(50246,1370493788641,4191489,4191489),(50246,1370481461465,5738323,5738323),(50246,1370463491712,5777619,5777619),(50246,1370480441319,5417000,5417000),(50246,1370475629623,5859940,5859940),(50246,1370487573922,4889479,4889479),(50246,1370475679688,5823315,5823315),(50246,1370469683262,5641238,5641238),(50246,1370469974461,5911258,5911258),(50246,1370460047869,5673060,5673060),(50246,1370459092643,5167099,5167099),(50246,1370450663269,5748104,5748104),(50246,1370468349955,5722158,5722158),(50246,1370450699674,4889479,4889479),(50246,1370475629623,5941865,5941865),(50246,1370477510761,5780337,5780337),(50246,1370468312039,5488449,5488449),(50246,1370458119424,5834282,5834282),(50246,1370487731589,5673492,5673492),(50246,1370458119424,5925516,5925516),(50246,1370468312039,5823705,5823705),(50246,1370469974461,5877448,5877448),(50246,1370468969359,5738323,5738323),(50246,1370463554356,5910499,5910499),(50246,1370475629623,5942347,5942347),(50246,1370481137285,5892484,5892484),(50246,1370471787653,5759963,5759963),(50246,1370463010383,5641238,5641238),(50246,1370467789442,5417000,5417000),(50246,1370481326020,5738323,5738323),(50246,1370474132205,5262530,5262530),(50246,1370450699674,5863427,5863427),(50246,1370463345234,5840228,5840228),(50246,1370462670541,5866984,5866984),(50246,1370463345234,5167099,5167099),(50246,1370487731589,5863427,5863427),(50246,1370446762052,5748104,5748104),(50246,1370481461465,5840228,5840228),(50246,1370446762052,5722158,5722158),(50246,1370480405929,4191489,4191489),(50246,1370477689325,5761385,5761385),(50246,1370491199962,5685982,5685982),(50246,1370467789442,5834282,5834282),(50246,1370450742858,5807217,5807217),(50246,1370474163380,5359887,5359887)],[(50246,1370481903572,5167099),(50246,1370463514656,5958234)])
    print mem
    print impr
    print view 

    pairs = NonView(impr, view) 
    print pairs

